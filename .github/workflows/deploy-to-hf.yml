name: 🚀 Deploy to Hugging Face Spaces

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - '*.md'
  
  workflow_dispatch: # Manual trigger

env:
  HF_SPACE: Really-amin/ultichat-hugginigfae

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub
    
    - name: 🔐 Login to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        huggingface-cli login --token $HF_TOKEN
    
    - name: 🏗️ Prepare deployment files
      run: |
        # Ensure all required files exist
        echo "Checking deployment files..."
        
        # Verify critical files
        for file in "app.py" "requirements.txt" "Dockerfile"; do
          if [ ! -f "$file" ]; then
            echo "❌ Error: Required file '$file' not found"
            exit 1
          fi
        done
        
        # Create logs directory if it doesn't exist
        mkdir -p logs temp uploads
        
        # Set correct permissions
        chmod 755 app.py
        
        echo "✅ All deployment files ready"
    
    - name: 🧪 Validate Python syntax
      run: |
        python -m py_compile app.py
        echo "✅ Python syntax validation passed"
    
    - name: 🚀 Deploy to Hugging Face Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        huggingface-cli upload $HF_SPACE . \
          --repo-type=space \
          --commit-message="🤖 Auto-deploy: $(git log -1 --pretty=%B | head -1)" \
          --commit-description="Deployed from GitHub commit: ${{ github.sha }}" \
          --exclude=".git/*" \
          --exclude="tests/*" \
          --exclude="scripts/*" \
          --exclude="deployment/*" \
          --exclude="*.md" \
          --exclude=".github/*"
    
    - name: ✅ Deployment Summary
      run: |
        echo "## 🎉 Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "- **Space URL**: https://huggingface.co/spaces/$HF_SPACE" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🌐 **Live Demo**: [Open in Hugging Face](https://huggingface.co/spaces/$HF_SPACE)" >> $GITHUB_STEP_SUMMARY
        
  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: 🚨 Notify on Failure
      run: |
        echo "## ❌ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
        echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
        echo "Common issues to check:" >> $GITHUB_STEP_SUMMARY
        echo "- HF_TOKEN secret is set correctly" >> $GITHUB_STEP_SUMMARY
        echo "- app.py runs on port 7860" >> $GITHUB_STEP_SUMMARY
        echo "- requirements.txt is complete" >> $GITHUB_STEP_SUMMARY
        echo "- Dockerfile syntax is correct" >> $GITHUB_STEP_SUMMARY